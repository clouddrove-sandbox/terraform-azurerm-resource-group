name: Create Branch and Pull Request

on:
  workflow_dispatch:
    inputs:
      pr-title:
        description: 'Pull request title'
        required: false
        default: 'chore: add terraform comments'

jobs:
  create-branch-and-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate random branch name
        id: branch-gen
        run: |
          RANDOM_NAME="auto-$(date +%s)-$RANDOM"
          echo "name=$RANDOM_NAME" >> $GITHUB_OUTPUT

      - name: Add comments to Terraform files
        run: |
          #!/bin/bash
          
          # Find all .tf files
          tf_files=$(find . -name "*.tf" -type f | grep -v ".terraform" | head -5)
          
          if [ -z "$tf_files" ]; then
            echo "No Terraform files found!"
            exit 1
          fi
          
          # Add comment to each file
          for file in $tf_files; do
            echo "" >> "$file"
            echo "# Updated: $(date '+%Y-%m-%d %H:%M:%S')" >> "$file"
            echo "# Automated update by GitHub Actions" >> "$file"
            echo "Updated: $file"
          done
          
          echo "✅ Comments added to Terraform files"
        shell: bash

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB }}  # ⭐ Changed from GITHUB_TOKEN to PAT
          commit-message: 'chore: add terraform file comments'
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: feature/${{ steps.branch-gen.outputs.name }}
          delete-branch: true
          title: ${{ inputs.pr-title }}
          body: |
            ## Automated Terraform Update
            
            Terraform files automatically updated with comments by workflow.
            
            **Branch:** feature/${{ steps.branch-gen.outputs.name }}
            **Triggered by:** @${{ github.actor }}
            **Timestamp:** $(date)
          labels: |
            terraform
            automated
            github_actions
          draft: false

      - name: PR Details
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "✅ Pull Request Created!"
          echo "PR #${{ steps.cpr.outputs.pull-request-number }}"
          echo "URL: ${{ steps.cpr.outputs.pull-request-url }}"
