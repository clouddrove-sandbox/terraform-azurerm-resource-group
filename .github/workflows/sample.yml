---
name: Automerge

on:
  workflow_call:
    inputs:
      tfcheck:
        description: 'Enter the tfcheck action name.'
        required: false
        type: string
      tfchecks_azure:
        description: 'List of Azure TF checks (JSON array as string)'
        required: false
        type: string
        default: '["pr-validation / üìù Validate PR title", "pr-validation / üßæ Validate Commit Messages", "tf-lint / tflint"]'
      azure_cloud:
        description: 'Enable Azure-specific checks'
        required: false
        type: boolean
        default: false
    secrets:
      GITHUB:
        description: 'GitHub Token'
        required: false

jobs:
  static-checks:
    name: Check Static Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tf-checks: ["tf-lint / tflint", "tfsec / tfsec sarif report", "${{ inputs.tfcheck }}"]
    if: github.actor == 'github-actions[bot]' && !inputs.azure_cloud
    steps:
      - name: Wait for 2 Minutes
        run: sleep 120
        shell: bash

      - name: Wait for "${{ matrix.tf-checks }}" to Succeed
        env:
          GH_TOKEN: ${{ secrets.GITHUB || secrets.GITHUB_TOKEN }}
          CHECK_NAME: ${{ matrix.tf-checks }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
        run: |
          #!/bin/bash
          set -e
          
          MAX_ATTEMPTS=60
          WAIT_INTERVAL=30
          attempt=0
          
          echo "Waiting for check: $CHECK_NAME"
          
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            # Get check runs for this commit
            check_status=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$REPO/commits/$PR_SHA/check-runs" \
              --jq ".check_runs[] | select(.name == \"$CHECK_NAME\") | .conclusion")
            
            if [ -z "$check_status" ]; then
              echo "Check not found yet, waiting..."
            elif [ "$check_status" == "success" ]; then
              echo "‚úÖ Check '$CHECK_NAME' succeeded!"
              exit 0
            elif [ "$check_status" == "null" ]; then
              echo "Check is still running..."
            else
              echo "‚ùå Check '$CHECK_NAME' failed with conclusion: $check_status"
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$MAX_ATTEMPTS - waiting ${WAIT_INTERVAL}s..."
            sleep $WAIT_INTERVAL
          done
          
          echo "‚ùå Timeout waiting for check '$CHECK_NAME'"
          exit 1
        shell: bash

  static-checks-azure:
    name: Check Static Analysis for Azure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: read
      pull-requests: read
    if: |
      github.actor == 'github-actions[bot]' &&
      inputs.azure_cloud == true &&
      inputs.tfchecks_azure != '[]'
    strategy:
      matrix:
        tf-checks: ${{ fromJSON(inputs.tfchecks_azure) }}
    steps:
      - name: Wait for 2 Minutes
        run: sleep 120
        shell: bash

      - name: Wait for "${{ matrix.tf-checks }}" to Succeed
        env:
          GH_TOKEN: ${{ secrets.GITHUB || secrets.GITHUB_TOKEN }}
          CHECK_NAME: ${{ matrix.tf-checks }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
        run: |
          #!/bin/bash
          set -e
          
          MAX_ATTEMPTS=60
          WAIT_INTERVAL=30
          attempt=0
          
          echo "Waiting for check: $CHECK_NAME"
          
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            # Get check runs for this commit
            check_status=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$REPO/commits/$PR_SHA/check-runs" \
              --jq ".check_runs[] | select(.name == \"$CHECK_NAME\") | .conclusion")
            
            if [ -z "$check_status" ]; then
              echo "Check not found yet, waiting..."
            elif [ "$check_status" == "success" ]; then
              echo "‚úÖ Check '$CHECK_NAME' succeeded!"
              exit 0
            elif [ "$check_status" == "null" ]; then
              echo "Check is still running..."
            else
              echo "‚ùå Check '$CHECK_NAME' failed with conclusion: $check_status"
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$MAX_ATTEMPTS - waiting ${WAIT_INTERVAL}s..."
            sleep $WAIT_INTERVAL
          done
          
          echo "‚ùå Timeout waiting for check '$CHECK_NAME'"
          exit 1
        shell: bash

  autoapprove:
    permissions:
      contents: write
      pull-requests: write
    name: Auto Approve PRs by GitHub Actions Bot
    needs: [static-checks, static-checks-azure]
    runs-on: ubuntu-latest
    if: |
      always() &&
      github.actor == 'github-actions[bot]' &&
      (needs.static-checks.result == 'success' || needs.static-checks-azure.result == 'success')
    steps:
      - name: Approve PR via GitHub Bot
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Approve PR via Anmol Nagpal
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB}}

  automerge:
    runs-on: ubuntu-latest
    needs: autoapprove
    if: |
      always() &&
      needs.autoapprove.result == 'success' &&
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false
    steps:
      - name: Automerge
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB }}
          MERGE_FILTER_AUTHOR: 'github-actions[bot]'
          MERGE_METHOD: "merge"
          MERGE_DELETE_BRANCH: "true"
          MERGE_LABELS: "dependencies, github_actions"
          MERGE_REQUIRED_APPROVALS: ""
